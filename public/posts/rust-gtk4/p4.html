<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.svg">
  <link rel="mask-icon" href="/images/avatar.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="/lib/@fortawesome/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="/lib/animate.css/animate.min.css">
  <link rel="stylesheet" href="/lib/@fancyapps/fancybox/dist/jquery.fancybox.min.css">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jedsek.xyz","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":30,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#1E90FF","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}}},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本节将学习如何使用子类化(Subclassing), 从而定制自己的 Widget">
<meta property="og:type" content="article">
<meta property="og:title" content="rust-gtk4-p4~&gt; GObject: 子类化">
<meta property="og:url" content="https://jedsek.xyz/posts/rust-gtk4/p4">
<meta property="og:site_name" content="Jedsek&#39;s blog">
<meta property="og:description" content="本节将学习如何使用子类化(Subclassing), 从而定制自己的 Widget">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-10-09T14:52:26.000Z">
<meta property="article:modified_time" content="2022-10-09T14:52:26.000Z">
<meta property="article:author" content="Jedsek">
<meta property="article:tag" content="Rust">
<meta property="article:tag" content="GUI">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://jedsek.xyz/posts/rust-gtk4/p4.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jedsek.xyz/posts/rust-gtk4/p4","path":"posts/rust-gtk4/p4.html","title":"rust-gtk4-p4~> GObject: 子类化"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>rust-gtk4-p4~> GObject: 子类化 | Jedsek's blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Jedsek's blog" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Jedsek's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">与其浊富 | 宁比清贫</p>
      <img class="custom-logo-image" src="/images/avatar.svg" alt="Jedsek's blog">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="iconfont icon-home fa-fw"></i> 首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="iconfont icon-about fa-fw"></i> 关于</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="iconfont icon-Z-fenleidaohang fa-fw"></i> 分类</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#mu-lu-jie-gou"><span class="nav-number">1.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#zi-lei-hua"><span class="nav-number">2.</span> <span class="nav-text">子类化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#zi-ding-yi"><span class="nav-number">3.</span> <span class="nav-text">自定义</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shi-yong-qing-kuang"><span class="nav-number">4.</span> <span class="nav-text">使用情况</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>

    

    
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=2948804617&website=www.oicqzone.com" title=" QQ → tencent:&#x2F;&#x2F;AddContact&#x2F;?fromId&#x3D;45&amp;fromSubId&#x3D;1&amp;subcmd&#x3D;all&amp;uin&#x3D;2948804617&amp;website&#x3D;www.oicqzone.com" rel="noopener" target="_blank"><i class="iconfont icon-QQ fa-fw"></i> QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/673774482" title=" B站 → https:&#x2F;&#x2F;space.bilibili.com&#x2F;673774482" rel="noopener" target="_blank"><i class="iconfont icon-bilibili-fill fa-fw"></i> B站</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/zhu-xia-hun" title=" 知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zhu-xia-hun" rel="noopener" target="_blank"><i class="iconfont icon-zhihu-square-fill fa-fw"></i> 知乎</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jedsek@qq.com" title=" 邮箱 → mailto:jedsek@qq.com" rel="noopener" target="_blank"><i class="iconfont icon-email-fill fa-fw"></i> 邮箱</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jedsek.xyz/posts/rust-gtk4/p4">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.svg">
      <meta itemprop="name" content="Jedsek">
      <meta itemprop="description" content="人类的伟大之处<br>正是在于能够直面自身的渺小">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jedsek's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          rust-gtk4-p4~> GObject: 子类化
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-09 22:52:26" itemprop="dateCreated datePublished" datetime="2022-10-09T22:52:26+08:00">2022-10-09</time>
    </span>

  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.8k</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>本节将学习如何使用子类化(Subclassing), 从而定制自己的 Widget</p>
</blockquote>
<span id="more"></span>
<p>同系列传送门: <a href="/categories/rust-gui">rust-gui</a><br>
GNOME入坑指南: <a href="/posts/desktop-beautify/gnome">gnome</a></p>
<h1 id="mu-lu-jie-gou">目录结构</h1>
<p>gtk 基于 glib, 而 glib 最让人印象深刻的地方, 又是其 <code>Gobject System</code><br>
众所周知, C 是一套面向过程的语言, 但基于 C 的 glib库, 却通过高超的思想, 提供了面向对象的支持</p>
<p>在这样一个面向对象, 依赖继承的体系中, 我们可以通过子类化(Subclassing)来创建新的自定义的 GObject<br>
让我们保持这样子的目录结构:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="attribute">src</span></span><br><span class="line">├── custom_button</span><br><span class="line">│   ├── imp<span class="selector-class">.rs</span></span><br><span class="line">│   └── mod<span class="selector-class">.rs</span></span><br><span class="line">└── <span class="selector-tag">main</span>.rs</span><br></pre></td></tr></table></figure>
<p>在 glib 中, 我们将通过创建两个结构体来创建一个子类<br>
我们将会创建一个新的 GObject, 通过继承成为 <code>gtk::Button</code> 的子类, 以此添加一些自定义的功能</p>
<hr>
<h1 id="zi-lei-hua">子类化</h1>
<p>如上面的目录结构所示, 我们定义了一个叫 <code>custom_button</code> 的模块, 在 <code>mod.rs</code> 中将 <code>CustomButton</code> 暴露给外部<br>
其实这就是 C 语言中实现子类化的模板, 我们将遵循这个规则, 通过定义两个 struct 来描述子类:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>imp.rs</code> 被用来存储自定义的状态, 存储继承自父类待 override 的虚函数</p>
</li>
<li class="lvl-2">
<p><code>custom_button::imp</code> 是私有模块, <code>custom_button::imp::CustomButton</code> 也是私有的</p>
</li>
<li class="lvl-2">
<p><code>custom_button::imp::CustomButton</code> 将被暴露给外界的 <code>custom_button::CustomButton</code> 使用, 作为其养料</p>
</li>
</ul>
<p>简单来说, 我们正在利用模块, 对子类化的 GObject 的功能进行分门别类, 让其定义更加清晰罢了</p>
<p>下面是具体代码, 直接抄书:</p>
<figure class="highlight rust"><figcaption><span>src/custom_button/imp.rs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> gtk::glib;</span><br><span class="line"><span class="keyword">use</span> gtk::subclass::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Object holding the state</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CustomButton</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The central trait for subclassing a GObject</span></span><br><span class="line"><span class="meta">#[glib::object_subclass]</span></span><br><span class="line"><span class="keyword">impl</span> ObjectSubclass <span class="keyword">for</span> CustomButton &#123;</span><br><span class="line">    <span class="keyword">const</span> NAME: &amp;<span class="symbol">&#x27;static</span> <span class="built_in">str</span> = <span class="string">&quot;MyGtkAppCustomButton&quot;</span>;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Type</span></span> = super::CustomButton;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">ParentType</span></span> = gtk::Button;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trait shared by all GObjects</span></span><br><span class="line"><span class="keyword">impl</span> ObjectImpl <span class="keyword">for</span> CustomButton &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trait shared by all widgets</span></span><br><span class="line"><span class="keyword">impl</span> WidgetImpl <span class="keyword">for</span> CustomButton &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trait shared by all buttons</span></span><br><span class="line"><span class="keyword">impl</span> ButtonImpl <span class="keyword">for</span> CustomButton &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>先前也说了, 模块 <code>imp.rs</code> 的作用便是描述一个子类, 负责新添加的状态与待覆写的虚函数<br>
对于某个子类 GObject 的描述, 在 <code>ObjectSubclass</code> 中:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>NAME</code>: 该 GObject 的名字, 为避免命名冲突, 应使用 crate-name 与 object-name 组成 (UpperCamelCase)</p>
</li>
<li class="lvl-2">
<p><code>Type</code>: 指之后将被创建的, 实际的 GObject</p>
</li>
<li class="lvl-2">
<p><code>ParentType</code>: 我们继承的那个父类 GObject</p>
</li>
</ul>
<p>你可能会疑惑, 这个 <code>Name</code> 与 <code>Type</code> 是什么鬼, 就不能直接用 <code>Type (我们在Rust中实际创建的类型)</code> 作为 <code>NAME</code> 吗?</p>
<p>别忘了, gtk 是一套跨语言的通用 GUI 框架, 拥有几十种语言的绑定, 设计必然不能拘泥在一种语言上, 即使对 C 也不例外<br>
不同语言自有不同命名规范, 必然得先统一风格, 比如之后会学习的 <code>.ui</code> 为后缀的 xml 文件, 可以用来描述界面, 这可是不管哪个语言都通用的啊<br>
因此 <code>NAME</code> 是用来描述其名字, 而 <code>Type/ParentType</code> 则是特定于语言的某一个类型 (此处是Rust中的 <code>CustomButton</code>/<code>gtk::Button</code>)</p>
<p>再提一嘴, 之后将学习的以 <code>.ui</code> 为后缀的 xml 文件, 可以创建 GtkBuilder template class(模板类), 像下面这样去描述界面:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">interface</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">class</span>=<span class="string">&quot;GtkAppWindow&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;GtkApplicationWindow&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span>My GTK App<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">child</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 此处使用 `CustomButton` 指定 widget 的类型 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;CustomButton&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button_1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Press me!<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;margin-top&quot;</span>&gt;</span>12<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;margin-bottom&quot;</span>&gt;</span>12<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;margin-start&quot;</span>&gt;</span>12<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;margin-end&quot;</span>&gt;</span>12<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>你可能还会在之后对 gtk 框架的一些地方感到疑惑, 因此请记住: gtk 是一套通用的 gui 框架, 不止是为一种语言服务的</p>
<p>接下来是将暴露给外界的 <code>CustomButton</code>:</p>
<figure class="highlight rust"><figcaption><span>src/custom_button/mod.rs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">mod</span> imp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> glib::Object;</span><br><span class="line"><span class="keyword">use</span> gtk::glib;</span><br><span class="line"></span><br><span class="line">glib::wrapper! &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CustomButton</span></span>(ObjectSubclass&lt;imp::CustomButton&gt;)</span><br><span class="line">        @extends gtk::Button, gtk::Widget,</span><br><span class="line">        @implements gtk::Accessible, gtk::Actionable, gtk::Buildable, gtk::ConstraintTarget;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> CustomButton &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">with_label</span></span>(label: &amp;<span class="built_in">str</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Object::new(&amp;[(<span class="string">&quot;label&quot;</span>, &amp;label)])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>glib::wrapper!</code> 顾名思义, 能帮我们将 <code>imp::CustomButton</code> 进行包装, 自动生成相关实现, 避免大量样例代码, 我们只需指明其继承情况即可:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>@extends</code>: 指明所有父类 GObject</p>
</li>
<li class="lvl-2">
<p><code>@implements</code>: 指明所有实现的 Interface (在 Rust 中是 Trait)</p>
</li>
<li class="lvl-2">
<p><code>imp::CustomButton</code>: 经过宏成为了被暴露的 <code>CustomButton</code> 的 inner 成员</p>
</li>
<li class="lvl-2">
<p><code>with_label</code>: 添加了自己的将被暴露的新方法, 设置了 GObject 的 property (<code>Object::new</code> 的返回值是泛型, 此处会自动推导为 <code>Self</code>)</p>
</li>
</ul>
<p>我们可以通过 <a target="_blank" rel="noopener" href="https://docs.gtk.org/gtk4/class.Button.html#hierarchy">docs/gtk/hierarchy</a> 来查看某个 GObject 的继承链情况</p>
<p>现在, <code>CustomButton</code> 实际上已经与 <code>gtk::Button</code> 一样了, 因此我们可以直接用其替换 <code>Button</code>:</p>
<figure class="highlight rust"><figcaption><span>src/main.rs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">mod</span> custom_button;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> custom_button::CustomButton;</span><br><span class="line"><span class="keyword">use</span> gtk::prelude::*;</span><br><span class="line"><span class="keyword">use</span> gtk::&#123;Application, ApplicationWindow&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> APP_ID: &amp;<span class="built_in">str</span> = <span class="string">&quot;xyz.jedsek.myapp&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> app = Application::builder().application_id(APP_ID).build();</span><br><span class="line">    app.connect_activate(build_ui);</span><br><span class="line">    app.run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">build_ui</span></span>(app: &amp;Application) &#123;</span><br><span class="line">    <span class="keyword">let</span> button = CustomButton::with_label(<span class="string">&quot;Press me!&quot;</span>);</span><br><span class="line">    button.set_margin_top(<span class="number">12</span>);</span><br><span class="line">    button.set_margin_bottom(<span class="number">12</span>);</span><br><span class="line">    button.set_margin_start(<span class="number">12</span>);</span><br><span class="line">    button.set_margin_end(<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> window = ApplicationWindow::builder()</span><br><span class="line">        .application(app)</span><br><span class="line">        .title(<span class="string">&quot;My GTK App&quot;</span>)</span><br><span class="line">        .child(&amp;button)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    window.present();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 <code>mold -run cargo run</code>, 你会见识一模一样的效果 😃</p>
<hr>
<h1 id="zi-ding-yi">自定义</h1>
<p>没错, 这还不够, 如果费劲心思搞出来的子类只是和父类一般, 那就没必要搞了, 很简单的道理不是吗?<br>
令人兴奋的是, 我们还可以保存状态, 覆写虚函数!</p>
<p>下面是例子, 直接抄书, 我们将只覆写其中两个虚函数:</p>
<figure class="highlight rust"><figcaption><span>src/custom_button/imp.rs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::Cell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> gtk::glib;</span><br><span class="line"><span class="keyword">use</span> gtk::prelude::*;</span><br><span class="line"><span class="keyword">use</span> gtk::subclass::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Object holding the state</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">CustomButton</span></span> &#123;</span><br><span class="line">    number: Cell&lt;<span class="built_in">i32</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The central trait for subclassing a GObject</span></span><br><span class="line"><span class="meta">#[glib::object_subclass]</span></span><br><span class="line"><span class="keyword">impl</span> ObjectSubclass <span class="keyword">for</span> CustomButton &#123;</span><br><span class="line">    <span class="keyword">const</span> NAME: &amp;<span class="symbol">&#x27;static</span> <span class="built_in">str</span> = <span class="string">&quot;MyGtkAppCustomButton&quot;</span>;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Type</span></span> = super::CustomButton;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">ParentType</span></span> = gtk::Button;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trait shared by all GObjects</span></span><br><span class="line"><span class="keyword">impl</span> ObjectImpl <span class="keyword">for</span> CustomButton &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">constructed</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.parent_constructed();</span><br><span class="line">        <span class="keyword">self</span>.obj().set_label(&amp;<span class="keyword">self</span>.number.get().to_string());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trait shared by all widgets</span></span><br><span class="line"><span class="keyword">impl</span> WidgetImpl <span class="keyword">for</span> CustomButton &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trait shared by all buttons</span></span><br><span class="line"><span class="keyword">impl</span> ButtonImpl <span class="keyword">for</span> CustomButton &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">clicked</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.number.set(<span class="keyword">self</span>.number.get() + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">self</span>.obj().set_label(&amp;<span class="keyword">self</span>.number.get().to_string())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们为 <code>imp::CustomButton</code> 添加了一个状态, 也就是其成员 <code>number</code>, 随后覆写了两个虚函数<br>
(覆写构造函数时, 还得记得调用一下父类的构造函数, 完成整个构造链)</p>
<p>在被覆写的函数中, 我们都调用了 <code>self.obj()</code>, 你可以观察一下其签名:</p>
<figure class="highlight rust"><figcaption><span>glib::subclass::types::obj</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">obj</span></span>(&amp;<span class="keyword">self</span>) -&gt; crate::BorrowedObject&lt;Self::Type&gt;</span><br></pre></td></tr></table></figure>
<p>还记得 <code>Self::Type</code> 是什么吗? 没错, 就是被暴露的那个 <code>CustomButton</code>, 而非 <code>imp::CustomButton</code>, 它才是被使用的真正实例(instance)<br>
此处的 <code>obj()</code> 方法, 其别名就是 <code>instance()</code>, 得到的是在 <code>main.rs</code> 中被创建的那个真正实例的引用</p>
<p>顺便再复习一下, 防止有人看见这里而感疑惑: 为什么是 <code>clicked(&amp;self)</code> 而非 <code>clicked(&amp;mut self)</code>, 这样不应该更方便吗?<br>
这是因为每个 GObject 都是引用计数的, 所以能绕过编译器的检查(全是不可变借用), 之前提到过了</p>
<p>经过覆写虚函数, <code>CustomButton</code> 终于出现了有别于父类 <code>Button</code> 的新特性:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>被构造时: 初始化 label 为自己存储的状态数字</p>
</li>
<li class="lvl-2">
<p>被点击时: 会让存储的状态数字+1, 随后更新 label</p>
</li>
</ul>
<p>现在调用 <code>mold -run cargo run</code>, 你将得到一个按钮, 按钮的 label 初始时为 0, 被点击后不断+1</p>
<hr>
<h1 id="shi-yong-qing-kuang">使用情况</h1>
<p>什么情况下适合使用 <code>glib::wrapper</code> 来模拟继承呢 (Rust 语言层面上不支持继承, 因此叫模拟)</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>使用一个 widget, 其添加了自定义状态与覆写虚函数</p>
</li>
<li class="lvl-2">
<p>将 Rust 对象传递给要求参数是 GObject 的函数 (因为 gtk 不只是 Rust 的GUI框架, 还是其他许多语言的 GUI 框架)</p>
</li>
<li class="lvl-2">
<p>为某个对象添加 property 或 signal, 继承 glib 体系下的强大力量 (下面几节会讲)</p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Rust/" rel="tag"><i class="fa fa-tag"></i> Rust</a>
              <a href="/tags/GUI/" rel="tag"><i class="fa fa-tag"></i> GUI</a>
          </div>

        

    </footer>
  </article>
</div>





  <br>
    <hr>
    
    <div style="float: left;text-align:right" >
      <strong style="float: left">&lt;~~同系列: prev─┐</strong><br>
      <a style="font-style: italic;font-size: 130%" href="/posts/rust-gtk4/p3"> GObject: 内存管理 </a>
    </div>
    
    <div style="float: right;text-align:left">
      <strong style="float: right">┌─next :同系列~~&gt;</strong><br>
      <a style="font-style: italic; font-size: 130%" href="/posts/rust-gtk4/p5"> GObject: 通用类型 </a>
    </div>

      <div style="text-align: center;white-space: nowrap">
          <strong>&lt;~同系列目录~&gt;</strong><br>
          <a style="font-style: italic;font-size: 130%" href="/categories/rust-gui"> rust-gui </a>
      </div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  <span class="with-love">
    <i class="iconfont icon-aixin"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jedsek</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="iconfont icon-dantupailie"></i>
    </span>
    <span class="post-count">全站共 98k 字</span>
  </span>
</div>
    </div>
  </footer>

  
  <script src="/lib/animejs/lib/anime.min.js"></script>
  <script src="/lib/@next-theme/pjax/pjax.min.js"></script>
  <script src="/lib/jquery/dist/jquery.min.js"></script>
  <script src="/lib/@fancyapps/fancybox/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/lozad/dist/lozad.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"/lib/mermaid/dist/mermaid.min.js"}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script src="/js/third-party/fancybox.js"></script>


  




  <script src="/lib/quicklink/dist/quicklink.umd.js"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://jedsek.xyz/posts/rust-gtk4/p4.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>


  <script async src="/js/cursor/fireworks.js"></script>
<script src="/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '1px',
  right: '256px',
  left: '200000px',
  time: '0.02s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: false,
  label: '',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  for (i = 0; i < toggleButtons.length; i++) {
    toggleButtons[i].classList.add("darkmode-toggle--white");
  }
}
</script>

<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>
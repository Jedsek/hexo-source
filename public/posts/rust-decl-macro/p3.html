<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script class="next-config" data-name="main" type="application/json">{"hostname":"jedsek.xyz","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":30,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#1E90FF","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}}},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script><meta name="description" content="æ­£å¼ç³»ç»Ÿçš„å…³äº macro çš„ å£°æ˜ä¸ä½¿ç”¨"><meta property="og:type" content="article"><meta property="og:title" content="rust-dm-p3: å£°æ˜ä¸ä½¿ç”¨"><meta property="og:url" content="https://jedsek.xyz/posts/rust-decl-macro/p3"><meta property="og:site_name" content="Jedsek&#39;s blog"><meta property="og:description" content="æ­£å¼ç³»ç»Ÿçš„å…³äº macro çš„ å£°æ˜ä¸ä½¿ç”¨"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-09-20T12:06:15.000Z"><meta property="article:modified_time" content="2021-09-20T12:06:15.000Z"><meta property="article:author" content="Jedsek"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Macro"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://jedsek.xyz/posts/rust-decl-macro/p3.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jedsek.xyz/posts/rust-decl-macro/p3","path":"posts/rust-decl-macro/p3.html","title":"rust-dm-p3: å£°æ˜ä¸ä½¿ç”¨"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>rust-dm-p3: å£°æ˜ä¸ä½¿ç”¨ | Jedsek's blog</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Jedsek's blog" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Jedsek's blog</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">ä¸å…¶æµŠå¯Œ | å®æ¯”æ¸…è´«</p><img class="custom-logo-image" src="/images/avatar.jpg" alt="Jedsek's blog"></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="iconfont icon-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="iconfont icon-about fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="iconfont icon-Z-fenleidaohang fa-fw"></i>åˆ†ç±»</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview">ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kuang-jia-jian-li"><span class="nav-number">1.</span> <span class="nav-text">æ¡†æ¶å»ºç«‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#liang-chong-hong-can-shu"><span class="nav-number">2.</span> <span class="nav-text">ä¸¤ç§å®å‚æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#yuan-bian-liang"><span class="nav-number">2.1.</span> <span class="nav-text">å…ƒå˜é‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#yuan-zi-mian-liang"><span class="nav-number">2.2.</span> <span class="nav-text">å…ƒå­—é¢é‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#li-zi"><span class="nav-number">2.3.</span> <span class="nav-text">ä¾‹å­</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ben-zhi"><span class="nav-number">3.</span> <span class="nav-text">æœ¬è´¨</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hui-dao-macro"><span class="nav-number">4.</span> <span class="nav-text">å›åˆ°Macro</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#token-lei-xing-biao"><span class="nav-number">4.1.</span> <span class="nav-text">Tokenç±»å‹è¡¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tt"><span class="nav-number">4.2.</span> <span class="nav-text">TT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ast-jie-dian"><span class="nav-number">4.3.</span> <span class="nav-text">ASTèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pi-pei-zhu-yi-dian"><span class="nav-number">4.4.</span> <span class="nav-text">åŒ¹é…æ³¨æ„ç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pi-pei-wu-qu"><span class="nav-number">4.4.1.</span> <span class="nav-text">åŒ¹é…è¯¯åŒº</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qi-yi-xian-zhi"><span class="nav-number">4.4.2.</span> <span class="nav-text">æ­§ä¹‰é™åˆ¶</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=2948804617&website=www.oicqzone.com" title="QQ â†’ tencent:&#x2F;&#x2F;AddContact&#x2F;?fromId&#x3D;45&amp;fromSubId&#x3D;1&amp;subcmd&#x3D;all&amp;uin&#x3D;2948804617&amp;website&#x3D;www.oicqzone.com" rel="noopener" target="_blank"><i class="iconfont icon-QQ fa-fw"></i> QQ</a></span><span class="links-of-author-item"><a href="https://space.bilibili.com/673774482" title="Bç«™ â†’ https:&#x2F;&#x2F;space.bilibili.com&#x2F;673774482" rel="noopener" target="_blank"><i class="iconfont icon-bilibili-fill fa-fw"></i> Bç«™</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/zhu-xia-hun" title="çŸ¥ä¹ â†’ https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zhu-xia-hun" rel="noopener" target="_blank"><i class="iconfont icon-zhihu-square-fill fa-fw"></i> çŸ¥ä¹</a></span><span class="links-of-author-item"><a href="mailto:jedsek@qq.com" title="é‚®ç®± â†’ mailto:jedsek@qq.com" rel="noopener" target="_blank"><i class="iconfont icon-email-fill fa-fw"></i> é‚®ç®±</a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jedsek.xyz/posts/rust-decl-macro/p3"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Jedsek"><meta itemprop="description" content="äººç±»çš„ä¼Ÿå¤§ä¹‹å¤„<br>æ­£æ˜¯åœ¨äºèƒ½å¤Ÿç›´é¢è‡ªèº«çš„æ¸ºå°"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jedsek's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">rust-dm-p3: å£°æ˜ä¸ä½¿ç”¨</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-09-20 20:06:15" itemprop="dateCreated datePublished" datetime="2021-09-20T20:06:15+08:00">2021-09-20</time></span><span class="post-meta-item" title="æœ¬æ–‡å­—æ•°"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span> <span>8.4k</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>æ­£å¼ç³»ç»Ÿçš„å…³äº macro çš„ å£°æ˜ä¸ä½¿ç”¨</p></blockquote><span id="more"></span><p>åŒç³»åˆ—ä¼ é€é—¨:</p><ul class="lvl-0"><li class="lvl-2"><p><a href="/categories/rust-decl-macro">åšå®¢: rust-decl-macro</a></p></li><li class="lvl-2"><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Wv411W7FH?p=1">Bç«™è§†é¢‘: Rustç¼–ç¨‹è¯­è¨€-å£°æ˜å®</a></p></li></ul><h1 id="kuang-jia-jian-li">æ¡†æ¶å»ºç«‹</h1><p>å‰ä¸€èŠ‚,æˆ‘ä»¬å¤§æ¦‚æ¸…æ¥šäº†macroçš„ç»“æ„<br>ç°åœ¨è®©æˆ‘ä»¬å†æ¥ç®€å•å¤ä¹ ä¸€é:</p><ol><li class="lvl-3"><p><code>macro_rules!(è¿™æ˜¯ç‰¹ç‚¹è¯­æ³•)</code>æ¥åˆ›å»ºä¸€ä¸ªmacro</p></li><li class="lvl-3"><p><code>rule(s)(åŒ¹é…åˆ†æ”¯,ä»¥ &quot;å‚æ•°=&gt;å±•å¼€ä»£ç &quot; çš„å½¢å¼)</code>æ”¾åœ¨æœ€å¤–å±‚çš„èŠ±æ‹¬å·å†…</p></li><li class="lvl-3"><p>è°ƒç”¨å®æ—¶,å®å+æ„Ÿå¹å·+æ‹¬å·å†…ä¼ å‚,æ¯”å¦‚: <code>println!(some_str)</code></p></li></ol><p>ç°åœ¨ç¨å¾®æ·±å…¥ä¸€ç‚¹:<br>ä¸€ä¸ª <code>rule</code> å¯ä»¥è¢«è¿™æ ·æŠ½è±¡åœ°è¡¨ç¤º: (matcher)=&gt;(transcriber)<br>å®ƒç”±ä¸‰ä¸ªé‡è¦çš„éƒ¨åˆ†ç»„æˆ:</p><ul class="lvl-0"><li class="lvl-2"><p><code>matcher (åŒ¹é…å™¨)</code>:<br>ç”¨æ¥åŒ¹é…ä¼ å…¥çš„å‚æ•°</p></li><li class="lvl-2"><p><code>metavariable/literal (å…ƒå˜é‡/å­—é¢é‡)</code>:<br>ç»‘å®šä¼ å…¥çš„ä»£ç ç‰‡æ®µ,å‡ºç°äº <code>matcher</code></p></li><li class="lvl-2"><p><code>transcriber (è½¬å½•å™¨)</code>:<br>ç”¨æ¥åœ¨å®åŒ¹é…æˆåŠŸå,è¿›è¡Œä»£ç æ›¿æ¢</p></li></ul><p>ä»¥<code>println!</code>ä¸ºä¾‹å­,æˆ‘ä»¬å‘å…¶ä¼ å…¥äº†ä¸€äº›å‚æ•°,å®ƒç»™æˆ‘ä»¬æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºä¸Š<br>å› ä¸ºåŸæœ¬çš„<code>println!</code>æ¶‰åŠåˆ°<code>å«ç”Ÿæ€§</code>,<code>é‡å¤è¯­æ³•</code>,<code>è·¯å¾„ä½œç”¨åŸŸ</code>ç­‰,ä¸é€‚åˆæ–°é¸Ÿé˜…è¯»,æ‰€ä»¥æˆ‘æŠ½è±¡äº†å®ƒ:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> println &#123;</span><br><span class="line">    (<span class="comment">/* ç©ºå‚åŒ¹é… */</span>) =&gt; (<span class="comment">/* `æ¢è¡Œ` çš„ä»£ç  */</span>);</span><br><span class="line">    (<span class="comment">/* æœ‰å‚åŒ¹é… */</span>) =&gt; (<span class="comment">/* `æ‰“å°å‚æ•° + æ¢è¡Œ` çš„ä»£ç  */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>println</code>ç”±ä¸¤ä¸ª<code>rule</code>ç»„æˆ,æ¯ä¸ªçš„å½¢å¼éƒ½æ˜¯: <code>matcher=&gt;transcriber</code><br>ä»ä¸Šå¾€ä¸‹,æ¯ä¸ªruleçš„<code>matcher</code>ä¼šä¸ä¼ å…¥å‚æ•°å°è¯•åŒ¹é…<br>åŒ¹é…æ—¶, æ‹¬å·å…·æœ‰å¤šæ ·æ€§, è¯·çœ‹ä¸‹é¢</p><ol><li class="lvl-3"><p>åŒ¹é…è§„åˆ™:</p></li></ol><ul class="lvl-0"><li class="lvl-2"><p>åŒ¹é…åˆ°: å°±æ›¿æ¢ä¸º<code>transcriber</code>é‡Œé¢çš„ä»£ç </p></li><li class="lvl-2"><p>åŒ¹é…ä¸åˆ°: æ‰€æœ‰<code>matcher</code>éƒ½æ— æ³•ä¸<code>ä¼ å…¥å‚æ•°</code>è¿›è¡ŒåŒ¹é…,åˆ™ç¼–è¯‘æŠ¥é”™</p></li></ul><ol start="2"><li class="lvl-3"><p>æ‹¬å·å¤šæ ·æ€§:</p></li></ol><ul class="lvl-0"><li class="lvl-2"><p>æ¦‚å¿µ: <code>matcher</code>ä¸<code>transcriber</code>çš„æ‹¬å·,å¯ä»¥æ˜¯(),[],{}ä¸‰ç§ä¹‹ä¸€</p></li><li class="lvl-2"><p>å®šä¹‰æ—¶: æ¯”å¦‚, ruleå¯å†™æˆ <code>[pattern]=&gt;&#123;expansion&#125;</code></p></li><li class="lvl-2"><p>è°ƒç”¨æ—¶: ä¸€æ ·éµä»è¯¥è§„åˆ™, æ¯”å¦‚ <code>vec![0, 1,2,3]</code> ä¸ <code>pritnln!(&quot;xx&quot;)</code></p></li></ul><p>è€Œ<code>metavariable/literal</code>åˆ™å‡ºç°åœ¨<code>matcher</code>ä¸­,ç”¨äºåŒ¹é…å¹¶æ•è·ä»£ç ç‰‡æ®µ<br>åœ¨å¯¹åº”çš„<code>transcriber</code>ä¸­,åˆ™å¯ä»¥æ“æ§è¿™äº›<code>å…ƒå€¼</code>,å³æ“æ§æ•è·åˆ°çš„ä»£ç ç‰‡æ®µ</p><p>ç¨å¾®æœ‰ç‚¹è’™? æˆ‘ä¹Ÿæ²¡è®©ä½ èƒŒå“Ÿ, å¤šçœ‹å¤šç”¨å°±ä¼šäº†</p><hr><h1 id="liang-chong-hong-can-shu">ä¸¤ç§å®å‚æ•°</h1><p>æ˜¯æ—¶å€™å¼•å…¥ä¸€äº›æ–°çš„ä¸œè¥¿äº†, é¡ºä¾¿åŠ æ·±ä¸‹ä½ çš„å°è±¡</p><h2 id="yuan-bian-liang" id="å…ƒå˜é‡">å…ƒå˜é‡</h2><p>å…ƒå˜é‡, å³Metavariable<br>è®©æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> my_macro &#123;</span><br><span class="line">    ($a: expr) =&gt; &#123;</span><br><span class="line">        $a</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ($a: expr, $b: expr) =&gt; &#123;</span><br><span class="line">        $a + $b</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    my_macro!(<span class="number">1</span>);</span><br><span class="line">    my_macro!(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®å…¨éƒ¨å±•å¼€å, å¯ä»¥ç†è§£ä¸ºä¸‹é¢: </span></span><br><span class="line"><span class="comment">fn main() &#123;</span></span><br><span class="line"><span class="comment">    1;</span></span><br><span class="line"><span class="comment">    1 + 2;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>ä½ ä¼šæ³¨æ„åˆ°,æ¯ä¸ªruleä¹‹é—´çš„å‚æ•°, å…¶å£°æ˜éƒ½æœ‰ç‚¹å¥‡æ€ª:<br>æ¯”å¦‚: <code>$a:expr</code> -&gt; <code>$+å‚æ•°æ ‡è¯†ç¬¦+ç±»å‹</code></p><ol><li class="lvl-3"><p><code>$</code> è¿™ä¸ªå‰ç¼€æ˜¯å¹²å˜›çš„?<br>è¿™æ˜¾å¼è¯´æ˜, å®ƒæ˜¯ <code>metavariable</code>, å¯ä»¥åŒ¹é…å¹¶æ•è·ä»£ç ç‰‡æ®µ, è¿™é‡Œä¼šæ•è·è¡¨è¾¾å¼<br>è‡³äºä¸ºä½•è¦ç‰¹æ„åŠ $å‰ç¼€æ¥è¯´æ˜, åƒå‡½æ•°å‚æ•°é‚£æ ·ç›´æ¥ç”¨ä¸è¡Œå—?<br>ä¸‹é¢å°±è¦è®²åˆ°å•¦, åˆ«ç€æ€¥~</p></li><li class="lvl-3"><p>å…ˆçœ‹çœ‹ <code>expr</code> ç±»å‹:<br><code>expr</code>, å…¨ç§°ä¸º <code>expression(è¡¨è¾¾å¼)</code><br>ç¬¬ä¸€æ¬¡å®è°ƒç”¨æ—¶, ä¼ å…¥äº† <code>1(ä¸€ä¸ªå­—é¢é‡)</code>, è¿™å½“ç„¶æ˜¯ä¸ªexpr, ä¸ç¬¬ä¸€ä¸ªruleæˆåŠŸåŒ¹é…<br>è¿™æ—¶, <code>my_macro!(1)</code> è¿™ä¸ªéƒ¨åˆ†, å°±ä¼šè¢«æ›¿æ¢ä¸ºç›¸åº”çš„å±•å¼€ä»£ç `<br>(matcher(åŒ¹é…å™¨),metavariable(å…ƒå˜é‡),transcriber(è½¬å½•å™¨)éƒ½ç”¨åˆ°äº†å‘¢)</p></li></ol><p>ç®€å•æ¥è®², macroçš„æœ¬è´¨, å°±æ˜¯åŒ¹é…æ•è·ä¼ å…¥å‚æ•°, å°†è°ƒç”¨éƒ¨åˆ†æ›¿æ¢/å±•å¼€ä¸ºç›¸åº”ä»£ç <br>macroå°±åƒä¸ªcode generator: ä¸€æ®µç”¨æ¥ç”Ÿæˆcodeçš„code</p><p>æ³¨æ„:<br>macroå®é™…ä¸Š, æ˜¯å°†ä¼ å…¥éƒ¨åˆ†è§£æä¸ºä¸€ä¸ªASTèŠ‚ç‚¹<br>ç„¶åå°†è°ƒç”¨éƒ¨åˆ†, æ›¿æ¢ä¸ºä¸€ä¸ªæ–°çš„ASTèŠ‚ç‚¹<br>åœ¨æœ¬èŠ‚ä¸‹é¢, ä¼šæ›´è¯¦ç»†åœ°è®²è®²</p><h2 id="yuan-zi-mian-liang" id="å…ƒå­—é¢é‡">å…ƒå­—é¢é‡</h2><p>å…ƒå­—é¢é‡, å³Metaliteral<br>ä¸ºäº†åŠ æ·±å°è±¡ä¸å¼•å‡º <code>metaliteral</code> , æˆ‘ä»¬æ¥ç©ä¸ªå¯¹åº”æ¸¸æˆ:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">($a: expr) =&gt; &#123;$a&#125;;                     <span class="comment">// the first rule</span></span><br><span class="line">  |             |  </span><br><span class="line">  |         	|</span><br><span class="line">( <span class="number">1</span>      )      <span class="number">1</span>                       <span class="comment">// pass &amp;&amp; expand </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">($a: expr, $b: expr) =&gt; &#123; $a + $b&#125;;    <span class="comment">// the second rule</span></span><br><span class="line">  |      |  |              |    |</span><br><span class="line">  |      |  |              |    |</span><br><span class="line">( <span class="number">1</span>      ,  <span class="number">2</span>      ) =&gt;    <span class="number">1</span> +  <span class="number">2</span>      <span class="comment">// pass &amp;&amp; expand</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä½¿ç”¨ <code>|</code> æ¥è”ç³» <code>å½¢å‚ -- å®å‚</code><br>ä½ ä¼šæƒŠè®¶çš„å‘ç°, ä¼ å‚æ—¶çš„å¯¹åº”å…³ç³»ä»¬, é™¤äº† <code>$a -- 1</code> ä¸ <code>$b -- 2</code>, è¿˜æœ‰ä¸ª <code>, -- ,</code></p><p>å¯¹äºç¬¬äºŒä¸ªrule, å®ƒçš„å®šä¹‰ä¸­, åˆ†å‰²ä¸¤ä¸ªexprçš„é€—å·æœ¬èº«, ä¹Ÿæ˜¯å½¢å‚<br>è¿™ç§å›ºå®šçš„å‚æ•°, å¦‚åŒtokenä¸­çš„å­—é¢é‡ä¸€æ ·<br>æˆ‘å§‘ä¸”ç§°å®ƒä¸º <code>Literal Token(å­—é¢é‡æ ‡è®°)</code>, æˆ–è€… <code>Metaliteral (å…ƒå­—é¢é‡)</code><br>(å› ä¸ºæˆ‘ä¹Ÿä¸çŸ¥é“æœ‰ä»€ä¹ˆå¯¹åº”æœ¯è¯­, æ‰€ä»¥ç”¨äº† â€œå§‘ä¸”â€, çŸ¥é“çš„éº»çƒ¦å‘Šè¯‰æˆ‘)</p><p>å‡è‹¥ rule ä¸­çš„å‚æ•°æ²¡æœ‰ $å‰ç¼€ è¿›è¡ŒåŒºåˆ†:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> fuck &#123;</span><br><span class="line">    (a:expr) =&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    fuck!(<span class="number">1</span>);       <span class="comment">// No</span></span><br><span class="line">    fuck!(a:expr);  <span class="comment">// Yes ~~(Oh~)~~</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå®šä¹‰ä¸­çš„ â€œa:exprâ€(å®ƒæ˜¯ <code>MetaLiteral</code>)<br>ä¼ å…¥å›ºå®šå½¢å¼çš„ â€œa:exprâ€ æ—¶æ‰å¯å‘ç”ŸåŒ¹é…</p><p>åˆ‡è®°:<br>å½“ä½ æƒ³ç»‘å®šä¸€æ®µä»£ç ç‰‡æ®µ,å‚æ•°åå‰,å¿…é¡»åŠ ä¸Š$è¿›è¡Œå‰ç¼€ä¿®é¥°</p><h2 id="li-zi" id="ä¾‹å­">ä¾‹å­</h2><p>å‡è®¾æœ‰è¿™ä¹ˆä¸ªå® <code>map!</code>(è”æƒ³ä¸€ä¸‹<code>vec!</code>)<br>å®ƒèƒ½æ ¹æ® <code>=&gt;</code> åˆ¤æ–­å‡º <code>Key/Value</code>, ç„¶åç”Ÿæˆä¸€ä¸ª <code>HashMap</code><br>å¦‚ä¸‹:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> m = map![</span><br><span class="line">        <span class="string">&quot;å‰è‰¯å‰å½±&quot;</span> =&gt; <span class="number">33</span>,</span><br><span class="line">        <span class="string">&quot;ç©ºæ¡æ‰¿å¤ªéƒ&quot;</span> =&gt; <span class="number">41</span>,</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">// `m` çš„ç±»å‹ä¸º: std::collections::HashMap&lt;&amp;str, i32&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥å†™ä¸€ä¸ªè¿™æ ·çš„å®å§!<br>ä¸è¿‡æˆ‘ä»¬è¿˜æœªå­¦ä¹  <code>é‡å¤è¯­æ³•</code>, æ— æ³•å†™å‡ºæ¥æ”¶å¯å˜å‚æ•°çš„ <code>map!</code>, æ‰€ä»¥ç°åœ¨åªè®¨è®ºç®€é™‹ç‰ˆ:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> map &#123;</span><br><span class="line">    ($key:expr =&gt; $val:expr) =&gt; &#123;&#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> m = std::collections::HashMap::&lt;_,_&gt;::new();</span><br><span class="line">        m.insert($key, $val);</span><br><span class="line">        m</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> m = map!(<span class="string">&quot;æ™®é€šä¸Šç­æ—&quot;</span> =&gt; <span class="number">33</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,m);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å±•å¼€å, å¯ä»¥çœ‹ä½œæ˜¯:</span></span><br><span class="line"><span class="comment">fn main() &#123;</span></span><br><span class="line"><span class="comment">    let m = &#123;</span></span><br><span class="line"><span class="comment">        let mut m = std::collections::HashMap::&lt;_,_&gt;::new();</span></span><br><span class="line"><span class="comment">        m.insert(&quot;æ™®é€šä¸Šç­æ—&quot;, 33);</span></span><br><span class="line"><span class="comment">        m</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    println!(&quot;&#123;:?&#125;&quot;,m);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ä¸€ä¸ªç®€é™‹çš„DSL, ä½ å®šä¹‰äº†åˆ›å»ºHashMapçš„æ–°è¯­æ³•: <code>Key=&gt;Value</code><br>æ¥çœ‹çœ‹ä¸¤ç§å®å‚æ•°åœ¨å®ä¸­, å‘æŒ¥ç€æ€æ ·çš„ä½œç”¨:</p><ul class="lvl-0"><li class="lvl-2"><p><code>Metavariable</code>: å°†æ•è·çš„ä¼ å…¥çš„ä»£ç ç‰‡æ®µç»‘å®šåˆ°è‡ªèº«<br>å¹¶åœ¨ <code>Transcriber</code> ä¸­è¢«ä½¿ç”¨, æœ€åå±•å¼€ä¸ºæ–°ä»£ç </p></li><li class="lvl-2"><p><code>Metaliteral</code> : é™å®šäº†åŒ¹é…, ä¼ å…¥çš„ä»£ç ç‰‡æ®µ, å¿…é¡»ä»¥ =&gt; åˆ†å‰², æ‰èƒ½æˆåŠŸåŒ¹é…è‹¥æ”¹æˆ <code>map!(&quot;æ™®é€šä¸Šç­æ—&quot;, 33)</code>, åˆ™æ¯ä¸ªruleçš„ <code>Matcher</code> éƒ½æ— æ³•åŒ¹é…ä¸Š<br>(è¿™é‡Œåªæœ‰ä¸€ä¸ªrule, ç©ºåŒ¹é…çš„æ‡’å¾—æ”¾é‡Œé¢äº†)</p></li></ul><p>å…¶å®è¯´äº†è¿™ä¹ˆå¤š, ç®€å•è®²å°±æ˜¯ä¸€ä¸ªå¯¹åº”æ¸¸æˆ, å¯¹åº”ä¸Šçš„è¯, å°±ä¼šæ›¿æ¢ä¸ºä¸€äº›ä»£ç <br>è€ƒè™‘çš„äº‹: åŒ¹é…çš„è¯­æ³•ç¾ä¸ç¾è§‚, ç®€ä¸ç®€å•, ç„¶åå°†å¤æ‚çš„ä»£ç éšè—, å°±è¿™æ ·è€Œå·²<br>ä¹‹åä¼šè€ƒè™‘è®²å‡ ä¸ªå°ä¾‹å­: æ¯”å¦‚æˆ‘åœ¨Bç«™ä¸Šå·²ç»å½•è¿‡çš„é€’æ¨åºåˆ—ç”Ÿæˆå™¨æ•™ç¨‹, æºè‡ªå®å°å†Œ<br>(åšå®¢çš„è¯, æˆ‘å‘¨å…­æ”¾å­¦å›æ¥æ…¢æ…¢æ›´å§â€¦)<br><s>(æ½œå°è¯æ˜¯éšæ—¶ä¼šé¸½å­)</s></p><hr><h1 id="ben-zhi">æœ¬è´¨</h1><p>macroçš„æœ¬è´¨, æ˜¯ç”Ÿæˆä¸€ä¸ªASTèŠ‚ç‚¹å¯ä»¥é…å¥—çœ‹çœ‹æˆ‘åœ¨Bç«™ä¸Šå®è§†é¢‘, è§†é¢‘è®²å¾—å¾ˆæµ…, å®¹æ˜“ç†è§£</p><p>å‡è‹¥ç”±ä½ æ¥è®¾è®¡ä¸€ä¸ªRustç¼–è¯‘å™¨<br>é¦–å…ˆ, ä¸åŒçš„äººå†™ä»£ç çš„é£æ ¼ä¸åŒ, é‚£ä¹ˆä½ å¦‚ä½•åˆ†æä¸åŒæºç , å¹¶ç”Ÿæˆç›®æ ‡ç ?</p><p>è‹¥æˆ‘ä»¬å°†æ¯éæ‰«æå¹¶åšç‚¹äº‹æƒ…çš„è¿‡ç¨‹, ç§°ä¸º<code>pass</code><br>passä¸€æ¬¡å°±ç”Ÿæˆäº†, å¯¹äºå¾ˆå¤§çš„æºç æ¥è¯´, è¿™ä¸ç°å®å§</p><p>é‚£æˆ‘ä»¬å°±passå¤šæ¬¡, å°† <code>ä»æºç ç¼–è¯‘ä¸ºç›®æ ‡ç </code> è¿™ä¸ªå¤§é—®é¢˜, åˆ†è§£ä¸ºä¸€å¤§å †å°é—®é¢˜<br>æ¯ä¸€æ¬¡passéƒ½è§£å†³ä¸€ä¸ªå°é—®é¢˜, é‚£ä¸å°±Okäº†å—</p><p>è¿™ç§ <code>ä¸­é—´è¡¨ç¤º</code>, å°±ç§°ä¸º <code>IR (Intermediate Representation )</code></p><p>æˆ‘ä»¬å¯ä»¥å…ˆæŠŠæºç æŠ½è±¡ä¸ºAST(æŠ½è±¡è¯­æ³•æ ‘, Abstract Syntax Tree)<br>é‚£æ˜¯ä¸€ç§ä»£ç è¢«æŠ½è±¡åçš„æ ‘çŠ¶ç»“æ„<br>æ¯”å¦‚æˆ‘ä»¬ç”¨Rustçš„enumè¡¨ç¤ºä¸€ä¸‹:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯¥æšä¸¾: ä¸€ä¸ªASTèŠ‚ç‚¹å¯ä»¥æ˜¯Intè¡¨è¾¾å¼æˆ–äºŒå…ƒè¿ç®—è¡¨è¾¾å¼  </span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ASTNode</span></span> &#123;</span><br><span class="line">    Int(<span class="built_in">i32</span>), </span><br><span class="line">    BinaryExpr &#123;</span><br><span class="line">        op: Op,</span><br><span class="line">        lhs: <span class="built_in">Box</span>&lt;ASTNode&gt;,</span><br><span class="line">        rhs: <span class="built_in">Box</span>&lt;ASTNode&gt;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äºŒå…ƒè¿ç®—çš„ç¬¦å·: è¿™é‡ŒåªæŠ½è±¡äº†åŠ æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Op</span></span> &#123;</span><br><span class="line">    Plus, </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½ åªéœ€æ˜ç™½ASTæ˜¯å¯¹æºç å°è£…çš„ä¸€å±‚æŠ½è±¡äº§ç‰©å°±å¯ä»¥äº†</p><p>å¯¹äºå¾ˆå°‘çš„æºç , å·²ç»å¯ä»¥ç›´æ¥è½¬æ¢ä¸ºç›®æ ‡ç äº†, æ¯•ç«Ÿè¿™æ—¶å€™ASTä¹Ÿå°<br>ä½†æ˜¯, å¦‚æœæºç å¾ˆå¤§å‘¢? ASTå·²ç»å¾ˆå¤æ‚äº†é‚£å°±å†æŠ½è±¡ä¸€å±‚å§, å‘ç›®æ ‡è¯­è¨€é€æ¸é æ‹¢, æ¯”å¦‚å‘æ±‡ç¼–é æ‹¢, æé«˜æ€§èƒ½</p><p>åŸºäºAST, æˆ‘ä»¬å¯ä»¥å†æ¥ä¸€äº›<code>IR</code>, å±‚å±‚é€’è¿›, ä»¥è¾¾ç›®çš„<br>æ³¨æ„,æ˜¯ä¸€äº›,è€Œä¸æ˜¯ä¸€ä¸ª,è¿™å¾ˆå¥½ç†è§£,å› ä¸ºä¸€å±‚å¯èƒ½è¿˜æ˜¯ä¸å¤Ÿå˜›</p><p><code>AST</code>å¾ˆé‡è¦, æ˜¯ç”Ÿæˆç›®æ ‡ç çš„å…³é”®, æ˜¯ä»£ç çš„éª¨æ¶<br>è€Œå¦å¤–çš„IR, ä¹Ÿæ˜¯æœ‰å¿…è¦çš„, è¿™ä¹Ÿå¢å¼ºäº†å¯ç»´æŠ¤æ€§<br>ç¼–è¯‘å™¨åœ¨ASTçš„åŸºç¡€ä¸Š, æœ€ç»ˆç”Ÿæˆäº†ç›®æ ‡ç </p><p>é—®: ç”ŸæˆASTéœ€è¦ç‚¹å•¥? æˆ–è€…è¯´, å®ƒç”±ä»€ä¹ˆç»„æˆ?<br>ç­”: ç”± expr(è¡¨è¾¾å¼), stmt(è¯­å¥), ;(æ ‡ç‚¹ç¬¦å·) ç­‰ç»„æˆ, è¿™äº›éƒ½å«åš <code>token</code></p><p>åœ¨è¿™äº›å°ç©æ„çš„åŸºç¡€ä¸Š, ç»„æˆä¸€ä¸ªæ›´åŠ åºå¤§å¤æ‚çš„æ•´ä½“ç»“æ„<br>å®ƒå°†tokenä»¬è”ç³»èµ·æ¥, è¡¨è¾¾äº†ä»£ç çš„éª¨æ¶<br>è¿™ä¸ªåºç„¶å¤§ç‰©ä¾¿æ˜¯ AST äº†</p><hr><h1 id="hui-dao-macro">å›åˆ°Macro</h1><h2 id="token-lei-xing-biao" id="Tokenç±»å‹è¡¨">Tokenç±»å‹è¡¨</h2><p>ç”ŸæˆASTéœ€è¦TokenååŠ©<br>macro ä¸­, å…¶å‚æ•°çš„ç±»å‹, ä¾¿æ˜¯tokenç±»å‹</p><p>macroè¦æ“æ§ä¼ å…¥çš„token (æˆ–ASTèŠ‚ç‚¹, ç­‰ä¼šè®²)<br>é‚£ä¹ˆæˆ‘ä»¬æ€»å¾—çŸ¥é“tokenç±»å‹å§, ä¸ç„¶æ€çŸ¥å’‹æ“æ§?</p><p>åªæœ‰è§„å®šå®å‚æ•°çš„ç±»å‹, æ‰èƒ½ä¿è¯macroè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ (è¿™é‡ŒæŒ‡ <code>Metavariable</code>)</p><p>æ‰€ä»¥, è¾›è‹¦ä½ å°†ä¸‹é¢çš„è®°ä¸€ä¸‹<br>ç¨å¾®è®°ä¸‹, æœ‰å°è±¡å³å¯, å¤šç”¨å‡ ä¸‹ä¿è¯ä½ ç†Ÿæ‚‰å¾—ä¸è¡Œ:</p><table><thead><tr><th>åç§°</th><th>å¯¹åº”</th></tr></thead><tbody><tr><td>ident</td><td>æ ‡è¯†ç¬¦, å¦‚å‡½æ•°å, å˜é‡å, å…³é”®å­—</td></tr><tr><td>expr</td><td>expression, è¡¨è¾¾å¼,å¦‚<code>x</code>ä¸<code>1_i32</code></td></tr><tr><td>literal</td><td>literal expression, å³å­—é¢é‡è¡¨è¾¾å¼, æ˜¯exprçš„å­é›†</td></tr><tr><td>pat</td><td>pattern, æ¯”å¦‚åœ¨matchè¡¨è¾¾å¼ä¸‹çš„ (pattern) =&gt; todo!()</td></tr><tr><td>path</td><td>è·¯å¾„, æ³¨æ„è¿™é‡Œä¸æŒ‡æ–‡ä»¶è·¯å¾„, è€Œæ˜¯ç±»ä¼¼ std::io::stdin çš„</td></tr><tr><td>ty</td><td>type, å¦‚ i32, u32, String, Option<t>ç­‰</t></td></tr><tr><td>tt</td><td>token tree, ä¹‹åæˆ‘ä¼šå•ç‹¬å†è®²è§£ä¸‹å®ƒçš„</td></tr><tr><td>meta</td><td>å…ƒæ¡ç›®/é¡¹, æ¯”å¦‚ <code>#[allow(unsued)]</code>, <code>meta</code> å°±å¯¹åº” <code>allow(unuse)</code></td></tr><tr><td>vis</td><td>visibility, å¯è§æ€§, æ¯”å¦‚pub, pub(crate)ç­‰, ä¹Ÿå¯èƒ½ä¸ºç©º</td></tr><tr><td>lifetime</td><td>ç”Ÿå‘½å‘¨æœŸ</td></tr><tr><td>item</td><td>æ¡ç›®/é¡¹, ä¾‹å¦‚å‡½æ•°å®šä¹‰</td></tr><tr><td>block</td><td>ä»£ç å—</td></tr><tr><td>stmt</td><td>statemen, è¯­å¥</td></tr></tbody></table><h2 id="tt" id="TT">TT</h2><p>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹ <code>tt (Token Tree)</code><br>ä»å­—é¢ä¸Šçš„æ„æ€æ¥è®², å°±æ˜¯ç”±Tokenç»„æˆçš„æ ‘(æ•°æ®ç»“æ„ä¸Šçš„æ ‘)å‘—~~(åºŸè¯)~~</p><p><code>tt</code>,å¯ä»¥æ•è·<code>Single Token</code>,æˆ–ç”±(),[],{}åŠæ‹¬å·åŒ…è£¹èµ·æ¥çš„ä¸œè¥¿<br>ä½œä¸º Token Tree çš„æ ¹èŠ‚ç‚¹, å…ˆè®©æˆ‘ä»¬æ¥ç‚¹ä¾‹å­:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> aa &#123;</span><br><span class="line">    ($a:tt) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>($a));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="comment">// Single Token</span></span><br><span class="line">    aa!(<span class="number">123</span>);          <span class="comment">// Yes: 123</span></span><br><span class="line">    aa!(FuckYou);      <span class="comment">// Yes: FuckYou</span></span><br><span class="line">    <span class="comment">// aa!(Fuck You);     // No</span></span><br><span class="line">    <span class="comment">// aa!(123 + 11);     // No</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// (), [], &#123;&#125;</span></span><br><span class="line">    aa!([<span class="number">123</span>]);        <span class="comment">// Yes: [123]</span></span><br><span class="line">    aa!(&#123;<span class="number">123</span> + <span class="number">123</span>&#125;);  <span class="comment">// Yes: &#123; 123 + 123 &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç , å±•ç¤ºäº† <code>tt</code> å¯ä»¥åŒ¹é…æ•è·å“ªäº›ä¸œè¥¿<br>è¯·çœ‹ä»¥ä¸‹å†…å®¹, ä»¥ç†è§£å®ƒ, æˆ‘ä»¬ä»¥<code>&lt;&lt;xxx&gt;&gt;</code>, æ¥è¡¨ç¤º <code>xxx</code> æ˜¯ä¸€é¢— <code>Token Tree</code></p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½ çš„çœ¼ä¸­:</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span> + (<span class="number">3</span> + <span class="number">4</span>)</span><br><span class="line"><span class="comment">// ttçš„çœ¼ä¸­:</span></span><br><span class="line">&lt;&lt;<span class="number">1</span>&gt;&gt; &lt;&lt;+&gt;&gt; &lt;&lt;<span class="number">2</span>&gt;&gt; &lt;&lt;+&gt;&gt; &lt;&lt;( )&gt;&gt;</span><br><span class="line">                           |</span><br><span class="line">                           |</span><br><span class="line">                   &lt;&lt;<span class="number">3</span>&gt;&gt; &lt;&lt;+&gt;&gt; &lt;&lt;<span class="number">4</span>&gt;&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„Token Treeå…±æœ‰5ä¸ª:</p><ol><li class="lvl-3"><p>&lt;&lt;1&gt;&gt;</p></li><li class="lvl-3"><p>&lt;&lt;+&gt;&gt;</p></li><li class="lvl-3"><p>&lt;&lt;2&gt;&gt;</p></li><li class="lvl-3"><p>&lt;&lt;+&gt;&gt;</p></li><li class="lvl-3"><p>&lt;&lt;(3 + 4)&gt;&gt;</p></li></ol><p>å¯¹äºå‰é¢4ä¸ª, éƒ½æ˜¯Single Token, ä¹Ÿå°±æ˜¯åªæœ‰æ ¹èŠ‚ç‚¹è‡ªå·±çš„Tree<br>å¯¹äºç¬¬5ä¸ª, å› ä¸ºæœ‰()åŒ…è£¹, &lt;&lt;(â€¦)&gt;&gt; ä½œä¸ºæ ¹èŠ‚ç‚¹, å®ƒè¿˜æœ‰ä¸‰ä¸ªå­èŠ‚ç‚¹(è¿™é‡Œæ­£å¥½åŒå±‚)</p><p>æœ‰æ²¡æœ‰å¯¹ <code>Tokenåé¢è·Ÿç€Tree</code> æ›´åŠ ç†è§£?</p><h2 id="ast-jie-dian" id="ASTèŠ‚ç‚¹">ASTèŠ‚ç‚¹</h2><p>macro ä¼šå°†ä¼ å…¥çš„token, è§£æä¸ºå¯¹åº”ç±»å‹çš„ASTèŠ‚ç‚¹(é™¤äº†å°‘é‡tokenç±»å‹, ç­‰ä¸‹ä¼šè®²)<br>æ¯”å¦‚ <code>map!</code> ä¸­, <code>$key:value</code> ä¸ <code>$val:expr</code>, éƒ½ä¼šè¢«è§£æä¸ºexprç±»å‹çš„ASTèŠ‚ç‚¹:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> map &#123;</span><br><span class="line">    ($key:expr =&gt; $val:expr) =&gt; &#123;&#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> m = std::collections::HashMap::&lt;_,_&gt;::new();</span><br><span class="line">        m.insert($key, $val);</span><br><span class="line">        m</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> m = map!(<span class="string">&quot;æ™®é€šä¸Šç­æ—&quot;</span> =&gt; <span class="number">33</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,m);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å±•å¼€å, å¯ä»¥çœ‹ä½œæ˜¯:</span></span><br><span class="line"><span class="comment">fn main() &#123;</span></span><br><span class="line"><span class="comment">    let m = &#123;</span></span><br><span class="line"><span class="comment">        let mut m = std::collections::HashMap::&lt;_,_&gt;::new();</span></span><br><span class="line"><span class="comment">        m.insert(&quot;æ™®é€šä¸Šç­æ—&quot;, 33);</span></span><br><span class="line"><span class="comment">        m</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    println!(&quot;&#123;:?&#125;&quot;,m);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ macro , ç«™åœ¨äº†æ›´æŠ½è±¡çš„è§†è§’ä¸Š<br>æ“æ§ä¼ å…¥çš„token(æˆ–è§£ætokenåå½¢æˆçš„ASTèŠ‚ç‚¹), ç»„æˆæ–°ASTèŠ‚ç‚¹(ç”Ÿæˆæ–°ä»£ç )</p><p>è¿™å¯ä»¥å¤§é‡ç®€åŒ–æ‰‹å†™é‡, å¦‚stdä¸­å‘å®ä¼ å…¥ç‰¹å®šç±»å‹, è‡ªåŠ¨ç”Ÿæˆä¸ºå®ƒä»¬å®ç°traitçš„ä»£ç </p><p>å€¼å¾—æ³¨æ„çš„æ˜¯, å®å°†ä¼ å…¥å‚æ•°ç»™ASTèŠ‚ç‚¹åŒ–æ—¶, æœ‰æ—¶æ„å‘³ç€ä¼šäº§ç”Ÿä¸æœŸæœ›çš„ç»“æœ<br>æˆ‘ç›´æ¥ç”¨ <a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/DaseinPhaos-tlborm-chinese/mbe-min-captures-and-expansion-redux.md">å®å°å†Œ</a> ä¸Šé¢çš„ä»£ç äº†:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> capture_then_match_tokens &#123;</span><br><span class="line">    ($e:expr) =&gt; &#123;match_tokens!($e)&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">macro_rules!</span> match_tokens &#123;</span><br><span class="line">    ($a:tt + $b:tt) =&gt; &#123;<span class="string">&quot;got an addition&quot;</span>&#125;;</span><br><span class="line">    (($i:ident)) =&gt; &#123;<span class="string">&quot;got an identifier&quot;</span>&#125;;</span><br><span class="line">    ($($other:tt)*) =&gt; &#123;<span class="string">&quot;got something else&quot;</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;\n&#123;&#125;\n&#123;&#125;\n&quot;</span>,</span><br><span class="line">        match_tokens!((caravan)),</span><br><span class="line">        match_tokens!(<span class="number">3</span> + <span class="number">6</span>),</span><br><span class="line">        match_tokens!(<span class="number">5</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;\n&#123;&#125;\n&#123;&#125;&quot;</span>,</span><br><span class="line">        capture_then_match_tokens!((caravan)),</span><br><span class="line">        capture_then_match_tokens!(<span class="number">3</span> + <span class="number">6</span>),</span><br><span class="line">        capture_then_match_tokens!(<span class="number">5</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœä¼šæ˜¯:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">got an identifier</span><br><span class="line">got an addition</span><br><span class="line">got something <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">got something <span class="keyword">else</span></span><br><span class="line">got something <span class="keyword">else</span></span><br><span class="line">got something <span class="keyword">else</span></span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™é‡Œ, <code>match_tokens</code> æ•è·token, ç„¶åå°†å‚æ•°è§£æä¸ºä¸€ä¸ªexprç±»å‹çš„ASTèŠ‚ç‚¹<br>å®ƒä¸å†æ˜¯token, è€Œæ˜¯ä¸ªASTèŠ‚ç‚¹äº†!</p><p>æ¯”å¦‚ <code>5 + 7</code>, åŸæœ¬æ˜¯å¯ä»¥ä¸ <code>$a:tt + $b:tt</code> ç›¸åŒ¹é…, ä¹Ÿå¯ä»¥ä¸ <code>$a: expr</code> åŒ¹é…<br>ä½†ç»äºŒæ¬¡ä¼ å…¥å(å‘ <code>capture_then_match_tokens</code>ä¼ å…¥çš„å‚æ•°åˆä¼ ç»™ <code>match_tokens</code>)<br><code>5 + 7</code> å˜æˆASTè¡¨è¾¾å¼èŠ‚ç‚¹, åªèƒ½ä¸ <code>$a: expr</code>, è€Œä¸èƒ½ä¸ <code>$a:tt + $b:tt</code> åŒ¹é…</p><p>åªæœ‰ <code>tt</code>, <code>ident</code>, <code>lifetime</code> èƒ½å…é­ ASTèŠ‚ç‚¹åŒ–, å¯ä»¥å¥½å¥½ç†è§£ä¸‹è¿™å—</p><p>æ€»ç»“:<br>å®å°†ä¸€äº›æ•è·çš„tokenç»™ASTèŠ‚ç‚¹åŒ–, éšååˆå±•å¼€ä¸ºä¸€ä¸ªæ–°ASTèŠ‚ç‚¹<br>è¿™ä¸ªæ–°çš„ASTèŠ‚ç‚¹, ä¼šç”¨æ¥æ›¿æ¢å®è°ƒç”¨éƒ¨åˆ†çš„ASTèŠ‚ç‚¹, å› æ­¤ä½ å¯ä»¥åœ¨å¾ˆå¤šåœ°æ–¹è°ƒç”¨å®<br>(åªè¦å®å±•å¼€çš„ASTèŠ‚ç‚¹æ­£ç¡®å³å¯ ğŸ˜„)</p><p>å®å±•å¼€çš„ç»“æœæ˜¯ä¸ªæŸç±»å‹çš„ASTèŠ‚ç‚¹, è¿™ç›¸æ¯”äºCè¯­è¨€çš„ <code>#define</code> å®, æœ‰ä»€ä¹ˆå¥½å¤„?<br>æœ€ç›´æ¥çš„å¥½å¤„, å¦‚ä¸‹ <s>(ç›¸å½“äºè‡ªåŠ¨ç»™ä½ åŠ ä¸Šäº†æ‹¬å·)</s>:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Cè¯­è¨€: ç®€å•çš„æ–‡æœ¬æ›¿æ¢</span></span><br><span class="line">#define SUM(a,b) a+b</span><br><span class="line">int main(void) &#123;</span><br><span class="line">    SUM(<span class="number">2</span>, <span class="number">2</span>);     <span class="comment">// 2 * 2</span></span><br><span class="line">    <span class="number">5</span> * SUM(<span class="number">2</span>, <span class="number">2</span>); <span class="comment">// 5 * 2 + 2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rustè¯­è¨€: æ ¹æ®ä¸Šä¸‹æ–‡æ¨æµ‹å®è°ƒç”¨çš„ASTèŠ‚ç‚¹åº”è¢«å±•å¼€ä¸ºexprç±»å‹çš„ASTèŠ‚ç‚¹</span></span><br><span class="line"><span class="built_in">macro_rules!</span> sum &#123;</span><br><span class="line">    ($a:expr,$b:expr) =&gt; &#123;$a + $b&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    sum!(<span class="number">2</span>,<span class="number">2</span>);     <span class="comment">// 2 + 2</span></span><br><span class="line">    <span class="number">5</span> * sum!(<span class="number">2</span>,<span class="number">2</span>); <span class="comment">// 5 * (2 + 2)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="pi-pei-zhu-yi-dian" id="åŒ¹é…æ³¨æ„ç‚¹">åŒ¹é…æ³¨æ„ç‚¹</h2><p>åœ¨æˆ‘ä»¬ä¼ å‚æ—¶, æœ‰ä¸ªå¾ˆå¸¸è§çš„è¯¯è§£, ä¸ä¸ºäº†ä»¥åå®çš„å‘å±•è€Œæœ‰çš„é™åˆ¶<br>å³ä¸‹é¢è¦è®²çš„ä¸œè¥¿, æœ‰æ—¶é—´çš„ä¹Ÿå¯ä»¥å»çœ‹çœ‹ <a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/DaseinPhaos-tlborm-chinese/mbe-min-captures-and-expansion-redux.md">å®å°å†Œ</a></p><h3 id="pi-pei-wu-qu" id="åŒ¹é…è¯¯åŒº">åŒ¹é…è¯¯åŒº</h3><p>æ¥çœ‹çœ‹ä¸‹é¢ä¸€æ®µä»£ç :</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> aa &#123;</span><br><span class="line">    ($a: expr) =&gt; &#123;&#125;;</span><br><span class="line">    ($a: ident +) =&gt; &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    aa!(a);   <span class="comment">// Yes</span></span><br><span class="line">    aa!(a+);  <span class="comment">// No</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ä½ çš„ç›´è§‰, <code>aa!(a+)</code> åº”è¯¥ä¼šä¸ç¬¬äºŒä¸ª rule ç›¸åŒ¹é…<br>ä½†æ˜¯å®é™…ä¸Šä¼šæŠ¥è¿™ä¹ˆä¸€ä¸ªé”™è¯¯:</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">expected expression, found end of <span class="keyword">macro</span> arguments</span><br><span class="line"><span class="comment">// æœŸæœ›è¡¨è¾¾å¼, å´å‘ç°å®å‚æ•°ç»“æŸäº†</span></span><br></pre></td></tr></table></figure><p>ä½ ä¼šå‘ç°å®é™…ä¸Šéƒ½æ˜¯åœ¨ä¸ç¬¬ä¸€ä¸ªruleå°è¯•ç€è¿›è¡ŒåŒ¹é…:</p><p><code>a (lhs, left hand side)</code> èƒ½è¢«ç¬¬ä¸€ä¸ªruleåŒ¹é…<br>è€Œ <code>+ (äºŒå…ƒåŠ )</code> å› ä¸ºå¯ä»¥å°¾éšè¡¨è¾¾å¼, ä¹Ÿå¯ä»¥è¢«ç¬¬ä¸€ä¸ªruleåŒ¹é…ä½†ç”±äºç¼ºå°‘ <code>rhs</code>, æ­¤æ—¶ä¼šç›´æ¥æŠ¥é”™, è€Œä¸æ˜¯å»å°è¯•åŒ¹é…ä¸‹ä¸€ä¸ªrule</p><p>è¿™é¿å…äº†æŸäº›æƒ…å†µä¸‹, å‘ç”Ÿä¸æœŸæœ›çš„åŒ¹é…, ä½†ä½ å´ä¸çŸ¥, å› æ­¤ruleçš„é¡ºåºå¾ˆé‡è¦</p><h3 id="qi-yi-xian-zhi" id="æ­§ä¹‰é™åˆ¶">æ­§ä¹‰é™åˆ¶</h3><p>ç”±äºä¸€äº›æ­§ä¹‰, ä¸ºäº†å‘åå…¼å®¹æ€§ä¸ä¸ç ´åä»£ç <br>å½“å‰å¯¹ <code>Metavariable</code> åé¢å¯ä»¥è·Ÿçš„å†…å®¹æœ‰æ‰€é™åˆ¶, è¯¦æƒ…å¯è§ <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/reference/macros-by-example.html#follow-set-ambiguity-restrictions">Rust-Reference: é™åˆ¶</a><br>è¿™é‡Œåªéœ€ç¨å¾®çœ‹çœ‹, ç•™ä¸ªå°è±¡, å®é™…ä½¿ç”¨æ—¶, è‹¥åœ¨æ­¤æ–¹é¢æŠ¥é”™, åˆ™æ ¹æ®ç¼–è¯‘å™¨çš„æç¤ºæ¥æ”¹å³å¯<br><s>(åˆ«é—®æˆ‘ä¸ºä»€ä¹ˆ xxx ç±»å‹åé¢, åŠ  yyy è¿™ä¸ªç¬¦å·ä¸å…è®¸)</s><br><s>(å› ä¸ºæˆ‘ä¹Ÿæ²¡æœ‰å…¨éƒ¨ææ‡‚)</s></p><p>å½“ç„¶, éšç€Rustå£°æ˜å®çš„é€æ¸å®Œå–„, é™åˆ¶ä¼šé€æ¸å‡å°‘(è™½ç„¶ä¹Ÿä¸å¤š)</p><p>é‚£ä¹ˆ, ä»Šå¤©å°±åˆ°è¿™äº†, è°¢è°¢æ‚¨çš„è§‚çœ‹ ğŸ˜ƒ</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Rust/" rel="tag"><i class="fa fa-tag"></i> Rust</a><a href="/tags/Macro/" rel="tag"><i class="fa fa-tag"></i> Macro</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/rust-decl-macro/p2" rel="prev" title="rust-dm-p2: ä»printlnå¼€å§‹"><i class="fa fa-chevron-left"></i> rust-dm-p2: ä»printlnå¼€å§‹</a></div><div class="post-nav-item"><a href="/posts/rust-decl-macro/p4" rel="next" title="rust-dm-p4: é‡å¤">rust-dm-p4: é‡å¤<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"><span class="with-love"><i class="iconfont icon-aixin"></i></span> <span class="author" itemprop="copyrightHolder">Jedsek</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="iconfont icon-dantupailie"></i></span> <span class="post-count">å…¨ç«™å…± 39k å­—</span></span></div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.2/dist/mermaid.min.js","integrity":"sha256-UIQPVkGifpwMvDH5yGgORJ9sSTDq38zz6BGU6dNaKhM="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://jedsek.xyz/posts/rust-decl-macro/p3.html"}</script><script src="/js/third-party/quicklink.js"></script><script async src="/js/cursor/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options={bottom:"1px",right:"256px",left:"200000px",time:"0.02s",mixColor:"transparent",backgroundColor:"transparent",buttonColorDark:"#100f2c",buttonColorLight:"#fff",saveInCookies:!1,label:"",autoMatchOsTheme:!1};const darkmode=new Darkmode(options);if(window.darkmode=darkmode,darkmode.showWidget(),window.darkmode&&!window.darkmode.isActivated()){window.darkmode.toggle();var toggleButtons=document.getElementsByClassName("darkmode-toggle");for(i=0;i<toggleButtons.length;i++)toggleButtons[i].classList.add("darkmode-toggle--white")}</script></body></html>